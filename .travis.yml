language: go

os:
  - linux
  - osx

go:
  - 1.7
  - 1.8

services:
  - docker
env:
  global:
    - CONTROLLER_IMAGE_NAME=bitnami/kubeless-controller
    - CONTROLLER_IMAGE=${CONTROLLER_IMAGE_NAME}:${TRAVIS_TAG:-build-$TRAVIS_BUILD_ID}
    - CGO_ENABLED=0

before_install:
  - set -e

install:
  - go get github.com/mitchellh/gox github.com/golang/lint/golint
  - >-
    wget -O $GOPATH/bin/kubecfg
    https://github.com/ksonnet/kubecfg/releases/download/v0.2.0/kubecfg-$(go env GOOS)-$(go env GOARCH)
  - chmod +x $GOPATH/bin/kubecfg
  - git clone --depth=1 https://github.com/ksonnet/ksonnet-lib.git
  - export KUBECFG_JPATH=$PWD/ksonnet-lib

script:
  - make test
  - make validation
  - make binary
  - |
    if [ "$TRAVIS_OS_NAME" = linux ]; then
      make controller-image CONTROLLER_IMAGE=$CONTROLLER_IMAGE
    fi
  - make kubeless.yaml

after_success:
  - |
    if [[ "$TRAVIS_OS_NAME" == linux && \
          "$TRAVIS_BRANCH" == master && \
          "$TRAVIS_PULL_REQUEST" == false && \
          "$TRAVIS_GO_VERSION" == "1.8" ]]; then
      docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
      docker tag $CONTROLLER_IMAGE ${CONTROLLER_IMAGE_NAME}:latest
      docker push ${CONTROLLER_IMAGE_NAME}:latest
    fi

before_deploy:
  - make binary-cross
  - for d in bundles/kubeless_*; do zip -r9 $d.zip $d/; done
  - |
    if [ "$TRAVIS_OS_NAME" = linux ]; then
      docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
      docker push $CONTROLLER_IMAGE
      NEW_DIGEST=$(./script/find_digest.sh ${CONTROLLER_IMAGE_NAME} ${TRAVIS_TAG} | cut -d " " -f 2)
      OLD_DIGEST=$(cat kubeless.yaml | grep ${CONTROLLER_IMAGE_NAME} |  cut -d "@" -f 2)
      sed -i 's/'"$OLD_DIGEST"'/'"$NEW_DIGEST"'/g' kubeless.yaml
    fi

deploy:
  provider: releases
  api_key:
    secure: tmGLe/aDko9VqGpc8bTxeKAOKxUKd+Yyt0VgE9aXH1CuXF9FB8qM1ZC+8f9PhiWAfEpHLLULQ0swMTDi/q4B1LvtK47O6jEp2lFOtOW3KEZKEvgvGNr47luwYDPOhZ1mk2rhIVhlH7YbWZjh7t+iK2KMw9Z7v7tzQzJi1tL9n5PplPoZ1RsUiy/nb+ChMz+ebE6eBa40WWjSaDdCaUithL16ZXDNjRFXfM9U3rWqNsKM0bExvtPfiWrWZdBW0Gu8oeUo040VzDURXWzxtwWs3emHJ4JhmwPLwvTnMk1Cr377LFuHQo4auoa4b4HSkza/2T+IceQE6A1P7qoyjU057u3U2vZIVvNbJvSLWQrayyo0P+zU5OxdeLKkanVEfmzIla3stN3PSXxYlxwBz2DhVuDtsS4UNOBJquvouNz+d7+z41g6UBstWc66us7gNzGcgcbcI2uXuO4g481wMK1YJPeBxUVHMccAWqJQtSMgCeBIUVopDRirRi8yklbwcCJbtoSDgKjMUIGSv/YV8pFu/OS803mFobq9A8RmLBTZGpK4STIFVxFMZy2GKV0xQ7ABbz/hjGzuosiv7jr6Ahm454Wt8KUdcThz9bGejKuh/LtBTEXZgPLCEtbSKL+whLl8nbhwOp/JTMX3u+agzeAKBWigHOEhprLF17KKyVaYRaU=
  file_glob: true
  file:
    - kubeless.yaml
    - bundles/kubeless_*.zip
  skip_cleanup: true
  overwrite: true
  on:
    tags: true
    repo: kubeless/kubeless
    go: 1.8
    os: linux
    condition: $CGO_ENABLED = 0
